<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/biings-ds@1.41.1/build/bds.css">
    <style type="text/css">
      table {
        width: 100%;
      }
      a {
        display: block;
        width: 100%;
      }
      .cell-shrink {
        width: 0.1%;
        white-space: nowrap;
      }
      .clear-button {
        pointer-events: auto;
        cursor: pointer;
      }
    </style>
    <script>
      let exclude = ['index.html', 'files.json']
      let path = ['.']
      let tree = []
      
      function setBreadcrumbs (value) {
        document.querySelector('.location').innerHTML = value
          .join('/')
          .replace(/^\./, '/')
          .replace(/^\/\//, '/') // :D
      }
      
      function getDirectory (cb) {
        let bits = decodeURIComponent(window.location.hash.replace('#', '')).split('&')
        for (let bit of bits) {
          let [key, value] = bit.split('=')
          if (key === 'path') {
            path = decodeURI(value).split('/')
            setBreadcrumbs(path)
          }
        }
        cb()
      }

      function getDirectoryContent (index, children) {
        if (index === path.length) {
          let parent = path.join('/')
          return children.map(function (item) {
            return { ...item, parent }
          })
        } else {
          let dirName = path[index]
          for (let item of children) {
            if (item.type === 'directory' && item.name === dirName) {
              return getDirectoryContent(index + 1, item.contents)
            }
          }
          return []
        }
      }
      
      function draw (content, highlight = '') {
          let files = ''
          if (path.length > 1) {
            let newPath = encodeURI(path.slice(0, path.length - 1).join('/'))
            files += `<tr>
              <td>
                <a href="#path=${newPath}" class="cell-shrink">
                  <svg class="image is-24x24"><use xlink:href="#key_return-g"></use></svg>
                </a>
              </td>
              <td>
                <a href="#path=${newPath}">Parent</a>
              </td>
              <td class="cell-shrink">
                <a href="#path=${newPath}">&nbsp;</a>
              </td>
            </tr>`
          }

          for (let item of content) {
            if (exclude.indexOf(item.name) === -1) {
              if (item.type === 'file') {
                let newPath = `${item.parent}/${item.name}`
                files += `<tr>
                  <td>
                    <a href="${newPath}">
                      <svg class="image is-24x24"><use xlink:href="#document-g"
                      style="visibility: visible"></use></svg>
                    </a>
                  </td>
                  <td>
                    <a href="${newPath}">${item.name}</a>
                  </td>
                  <td class="cell-shrink">
                    <a href="${newPath}">${item.time}</a>
                  </td>
                </tr>`
              }
              if (item.type === 'directory') {
                // let newPath = encodeURI(path.join('/') + `/${item.name}`)
                let newPath = encodeURI(item.parent + `/${item.name}`)
                files += `<tr>
                  <td>
                    <a href="#path=${newPath}">
                      <svg class="image is-24x24"><use xlink:href="#briefcase-g"></use></svg>
                    </a>
                  </td>
                  <td>
                    <a href="#path=${newPath}">${item.name}</a>
                  </td>
                  <td class="cell-shrink">
                    <a href="#path=${newPath}">&nbsp;</a>
                  </td>
                </tr>`
              }
            }
          }
          document.querySelector('.files').innerHTML = files
      }
      
      function updateContent () {
        getDirectory(function () {
          if (tree.length > 0) {
            let content = getDirectoryContent(0, tree)
            draw(content)
          }
        })
      }
      
      function clearSearch () {
        document.querySelector('#search').value = ''
        updateContent()
      }
      
      function doSearch (event = {}) {
        if (event.keyCode === 13) {
          let term = document.querySelector('#search').value.toLowerCase()
          if (term.length === 0) {
            updateContent()
          } else {
            setBreadcrumbs(['Search Results'])
            draw(search(term, [], tree))
          }
        }
      }
      
      
      function search (term, parent, children) {
        let found = []
        for (let item of children) {
          if (item.type !== 'report') {
            let _parent = parent.slice()
            if (item.name.toLowerCase().indexOf(term) > -1) {
              found.push({ parent: _parent.join('/'), name: item.name, type: item.type, time: item.time })
            }
            if (item.type === 'directory') {
              _parent.push(item.name)
              found = found.concat(search(term, _parent.slice(), item.contents))
            }
          }
        }
        return found
      }
      
      function encodeURI(str) {
        str.replace('&', '%26')
          .replace('#', '%23')
        return str
      }
      
      function showMessage(message = '', title = 'Error!', className = 'is-danger') {
        let html = `
          <td colspan="3">
            <div class="section">
              <div class="message has-text-centered ${className}">
                <h1 class='title'>${title}</h1>
                <p>
                  ${message}
                </p>
              </div>
            </div>
          </td>
        `
        document.querySelector('.files').innerHTML = html
      }
      
      function updateStatistics () {
        for (const item of tree) {
          if (item.type === 'report') {
            document.querySelector('.num-files').innerHTML = item.files
            document.querySelector('.num-dirs').innerHTML = item.directories
          }
        }
      }
      
      window.fetch('./files.json')
        .then(function (response) {
          if (response.status === 200) {
            return response.json()
          }
          if (response.status === 404) {
            showMessage('Could not load files.json. Did you forget to create one?')
          }
          if (response.status === 403) {
            showMessage('Could not load files.json because the web server is not allowed to read it. Did you set correct file permission?')
          }
          return []
        })
        .then(function (data) {
          tree = data
          updateContent()
          updateStatistics()
          window.onhashchange = updateContent
        })
        .catch(function (error) {
          showMessage('Unexpected error happened while loading files.json. For a more detailed error message, see browser developer console.')
          console.log(error)
        })
    </script>
  </head>
  <body>
    <div class="container">
      <div class="section columns is-8">
        <div class="column">
          <h1 class="title">Folder Contents</h1>
        </div>
        <div class="column is-4">
          <p class="control has-icons-left has-icons-right">
            <input class="input is-rounded" id="search" onkeyup="doSearch(event)"/>
            <svg class="icon is-left"><use xlink:href="#search-g"></use></svg>
            <svg class="icon is-right has-fill-grey-light"><use class="clear-button" onclick="clearSearch()" xlink:href="#cross-g"></use></svg>
          </p>
        </div>
      </div>
      <div class="section box is-raised">
        <div class="box location">
        </div>
        <table class="table is-hoverable">
          <thead>
            <tr>
              <th class="cell-shrink">&nbsp;</th>
              <th>Name</th>
              <th class="cell-shrink">Last Modified</th>
            </tr>
          </thead>
          <tbody class="files">
            <tr>
              <td>
                Loading...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="section">
        <p>
          <span class='num-files'>0</span> files in <span class='num-dirs'>0</span> directories.
        </p>
        <p>
          Update: <code>tree -J -D --dirsfirst --timefmt '%H:%M:%S %d.%m.%Y' > files.json</code>
        </p>
      </div>
    </div>
    <svg style="width: 0; height: 0" viewBox="0 0 24 24" id="briefcase-g"><path d="M19 6.5h-3v-1a3 3 0 00-3-3h-2a3 3 0 00-3 3v1H5a3 3 0 00-3 3v9a3 3 0 003 3h14a3 3 0 003-3v-9a3 3 0 00-3-3zm-9-1a1 1 0 011-1h2a1 1 0 011 1v1h-4v-1zm10 13a1 1 0 01-1 1H5a1 1 0 01-1-1V13a21.71 21.71 0 008 1.53A21.75 21.75 0 0020 13v5.5zm0-7.69a19.89 19.89 0 01-16 0V9.5a1 1 0 011-1h14a1 1 0 011 1v1.31z"></path></svg>
    <svg style="with: 0; height: 0" viewBox="0 0 24 24" id="document-g"><path d="M9 13a1 1 0 010-2h2a1 1 0 110 2H9zm0 4a1 1 0 010-2h6a1 1 0 110 2H9zm10.94-8.33c.03.088.05.178.06.27V19a3 3 0 01-3 3H7a3 3 0 01-3-3V5a3 3 0 013-3h6.06c.143 0 .264.02.364.06.103.047.243.162.326.24l6 6c.078.083.142.177.19.28v.09zM14 5.41V7a1 1 0 001 1h1.59L14 5.41zM18 19v-9h-3a3 3 0 01-3-3V4H7a1 1 0 00-1 1v14a1 1 0 001 1h10a1 1 0 001-1z"></path></svg>
    <svg style="width: 0; height: 0" viewBox="0 0 24 24" id="key_return-g"><path d="M6.789 12.45h8.861a2.6 2.6 0 000-5.2 1 1 0 010-2 4.6 4.6 0 010 9.2H6.789l3.445 3.72a1 1 0 11-1.468 1.36l-5-5.4a1 1 0 010-1.36l5-5.4a1 1 0 111.468 1.36l-3.445 3.72z"></path></svg>
    <svg style="width: 0; height: 0" viewBox="0 0 24 24" id="search-g"><path d="M16.12 17.534a8.5 8.5 0 111.414-1.414l4.815 4.815a1 1 0 01-1.414 1.414l-4.815-4.815zm-5.262-.176a6.5 6.5 0 100-13 6.5 6.5 0 000 13z"></path></svg>
    <svg style="width: 0; height: 0" viewBox="0 0 25 24" id="cross-g"><path fill-rule="evenodd" d="M12.5 22c-5.523 0-10-4.477-10-10s4.477-10 10-10 10 4.477 10 10-4.477 10-10 10zm0-11.374L9.908 8.035a.971.971 0 10-1.373 1.373L11.126 12l-2.591 2.592a.971.971 0 001.373 1.373l2.592-2.591 2.592 2.591a.971.971 0 001.373-1.373L13.874 12l2.591-2.592a.971.971 0 00-1.373-1.373L12.5 10.626z"></path></svg>
  </body>
</html>